<polymer-element name="pagecontent-auditlog" attributes="apiUrl cursor pageSize">

	<template>

		<style>
		
			div {
				padding: 10px;
				margin: 10px;
				border-radius: 10px;
			}
			
			.deleted {
				background-color: #FF9494;
				display: block;
			}
			
			.added {
				background-color : #85E085;
				display: block;
			}
		
		</style>
		<template repeat="{{ auditLog in auditLogDataList }}">
				<div style="background-color: #FAFAFA;">
					<span style="font-weight: bold;">{{ auditLog[ 'creationDate' ] }}</span>
					<span style="font-weight: bold;">{{ userList[ auditLog[ 'id' ]] }}</span>
					<span style="font-weight: bold;">{{ auditLog[ 'eventId' ] }}</span>
					<div id="Detail{{ auditLog[ 'id' ] }}" style="background-color: white;">
						<table>
							<template repeat="{{ key in keys }}">
								<template if="{{ eventDataNew[ auditLog[ 'id' ]][ key ] != null && eventDataOld[ auditLog[ 'id' ]][ key ] != null && eventDataNew[ auditLog[ 'id' ]][ key ] == eventDataOld[ auditLog[ 'id' ]][ key ] }}">
									<tr>
										<td>{{ key }}</td>
										<td>
											<span>{{ key == 'summary'? eventDataNew[ auditLog[ 'id' ]][ key ][ 'value' ] : eventDataNew[ auditLog[ 'id' ]][ key ] }}</span>
										</td>
									</tr>
								</template>
								<template if="{{ eventDataNew[ auditLog[ 'id' ]][ key ] != null && eventDataOld[ auditLog[ 'id' ]][ key ] != null && eventDataNew[ auditLog[ 'id' ]][ key ] != eventDataOld[ auditLog[ 'id' ]][ key ] }}">
									<tr>
										<td>{{ key }}</td>
										<td>
											<span class="deleted"> &#8211; {{ key == 'summary'? eventDataOld[ auditLog[ 'id' ]][ key ][ 'value' ] : eventDataOld[ auditLog[ 'id' ]][ key ] }}</span>
											<span class="added"> &#43; {{ key == 'summary'? eventDataNew[ auditLog[ 'id' ]][ key ][ 'value' ] : eventDataNew[ auditLog[ 'id' ]][ key ] }}</span>
										</td>
									</tr>
								</template>
								<template if="{{ eventDataOld[ auditLog[ 'id' ]][ key ] == null && eventDataNew[ auditLog[ 'id' ]][ key ] != null }}">
									<tr>
										<td>{{ key }}</td>
										<td>
											<span class="added"> &#43; {{ eventDataNew[ auditLog[ 'id' ]][ key ] }}</span>
										</td>
									</tr>
								</template>
								<template if="{{ eventDataNew[ auditLog[ 'id' ]][ key ] == null && eventDataOld[ auditLog[ 'id' ]][ key ] != null }}">
									<tr>
										<td>{{ key }}</td>
										<td>
											<span class="deleted"> &#8211; {{ eventDataOld[ auditLog[ 'id' ]][ key ] }}</span>
										</td>
									</tr>
								</template>
							</template>
						</table>
					</div>
				</div>
		</template>
		<div hidden?="{{ !isLoading }}">
			<paper-spinner active class="red"></paper-spinner>
			<span style="margin-left:10px;">Please wait...</span>
		</div>
		<div hidden?="{{ !isFinished }}">No more items !</div>
	
	
		<core-ajax
				id="AjaxGet"
				url="{{ apiUrl }}"
				contentType="application/json"
				method="GET"
				handleAs="json"
				on-core-response="{{ handleAjaxGetResponse }}"
				on-core-error="{{ handleAjaxGetError }}" >
		</core-ajax>

	</template>


	<script>

		Polymer( 'pagecontent-auditlog', {
			loadAuditLogList: function() {
				if( this.isLoading || this.isFinished )
					return;

				this.isLoading = true;
				
				var ajaxGet = this.$.AjaxGet;
				ajaxGet.params = JSON.stringify( { cursor:this.cursor, resultCount:this.pageSize } );
				ajaxGet.go();
			},

			handleAjaxGetResponse: function( event, response ) {
				this.cursor = response.response['cursor'];
				var auditLogDataList = response.response['auditLogDataList'];
				var userList = response.response[ 'userEmailList' ];
				for( var i = 0; i < auditLogDataList.length; i++ ){
					this.auditLogDataList.push( auditLogDataList[i] );
					this.userList[ auditLogDataList[i][ 'id' ] ] = userList[ auditLogDataList[i][ 'id' ] ];
					var eventDataOld = JSON.parse( auditLogDataList[i][ 'eventDataOld' ] );
					var eventDataNew = JSON.parse( auditLogDataList[i][ 'eventDataNew' ] );
					this.keys = Object.keys( eventDataNew );
					this.eventDataOld[ auditLogDataList[i][ 'id' ] ] = eventDataOld;
					this.eventDataNew[ auditLogDataList[i][ 'id' ] ] = eventDataNew;
				}
				
				this.isFinished = auditLogDataList.length < this.pageSize;
				this.isLoading = false;
				this.fire( 'load-success' );
			},

			handleAjaxGetError: function( event, response ) {
				this.isLoading = false;
				this.fire( 'load-error' );
			},

			ready: function() {
				this.auditLogDataList = [];
				this.userList = {};
				this.eventDataNew = {};
				this.eventDataOld = {};
				this.keys = [];
			}
		});
		
	</script>
	
</polymer-element>